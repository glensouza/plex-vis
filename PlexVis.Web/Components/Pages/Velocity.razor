@page "/velocity"
@using PlexVis.Web.Models
@using PlexVis.Web.Services
@inject PlexDataService PlexData

@rendermode InteractiveServer

<PageTitle>PlexVis - Viewing Velocity</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>‚ö° Viewing Velocity</h1>
        <p>Shows ordered by how quickly you typically watch new episodes. Lower days = higher urgency.</p>
    </div>

    @if (!PlexData.IsDatabaseConfigured)
    {
        <div class="setup-card">
            <h2>‚öôÔ∏è Setup Required</h2>
            <p>Please configure your Plex database to see velocity data.</p>
            <a href="/" class="btn-primary">Go to Dashboard</a>
        </div>
    }
    else
    {
        <div class="filter-section">
            <label for="userFilter" class="filter-label">üë§ Filter by User:</label>
            <select id="userFilter" class="user-filter-dropdown" @onchange="OnUserFilterChangedAsync" disabled="@isLoading">
                <option value="">All Users</option>
                @foreach (PlexAccount account in accounts)
                {
                    <option value="@account.Id" selected="@(selectedAccountId == account.Id)">@account.Name</option>
                }
            </select>
            @if (isLoading)
            {
                <span class="loading-indicator">Loading...</span>
            }
        </div>
    }

    @if (PlexData.IsDatabaseConfigured && velocityItems.Any())
    {
        <div class="velocity-table-container">
            <table class="velocity-table">
                <thead>
                    <tr>
                        <th>Show</th>
                        <th>Next Episode</th>
                        <th>Avg. Days</th>
                        <th>Velocity</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (ShowVelocity item in velocityItems)
                    {
                        <tr>
                            <td class="show-cell">@item.ShowTitle</td>
                            <td class="episode-cell">
                                <span class="season-ep">S@item.SeasonNum E@item.EpisodeNum</span>
                                <span class="ep-title">@item.EpisodeTitle</span>
                            </td>
                            <td class="days-cell metric-value">@item.AvgDaysToWatch.ToString("N1")</td>
                            <td>
                                <span class="velocity-badge @item.VelocityClass">@item.VelocityLabel</span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="legend">
            <h3>Understanding Velocity</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="velocity-badge badge-fast">‚ö° Fast</span>
                    <span>0-2 days after release</span>
                </div>
                <div class="legend-item">
                    <span class="velocity-badge badge-steady">üê¢ Steady</span>
                    <span>3-7 days after release</span>
                </div>
                <div class="legend-item">
                    <span class="velocity-badge badge-stale">üï∏Ô∏è Stale</span>
                    <span>8-30 days (Backlog building)</span>
                </div>
                <div class="legend-item">
                    <span class="velocity-badge badge-archived">üíÄ Archived</span>
                    <span>30+ days (Deep backlog)</span>
                </div>
            </div>
        </div>
    }
    else if (PlexData.IsDatabaseConfigured)
    {
        <div class="empty-state">
            <div class="empty-icon">üì∫</div>
            <h2>No Velocity Data Yet</h2>
            <p>Watch some TV episodes to start building your viewing velocity profile.</p>
        </div>
    }
</div>

@code {
    private IEnumerable<ShowVelocity> velocityItems = [];
    private IEnumerable<PlexAccount> accounts = [];
    private int? selectedAccountId;
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        if (PlexData.IsDatabaseConfigured)
        {
            accounts = await PlexData.GetAccountsAsync();
            velocityItems = await PlexData.GetViewingVelocityAsync();
        }
    }

    private async Task OnUserFilterChangedAsync(ChangeEventArgs e)
    {
        string? value = e.Value?.ToString();
        if (string.IsNullOrEmpty(value))
        {
            selectedAccountId = null;
        }
        else if (int.TryParse(value, out int accountId))
        {
            selectedAccountId = accountId;
        }
        else
        {
            selectedAccountId = null;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            velocityItems = await PlexData.GetViewingVelocityAsync(selectedAccountId);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
